<script>
        const socket = io();
        // ดึงรหัสจาก URL (เช่น /kiosk/9999 -> code = 9999)
        const pathParts = window.location.pathname.split('/');
        const hospCode = pathParts[pathParts.length - 1];

        // 1. เข้าห้องตามรหัส
        socket.on('connect', () => {
            console.log("Connected to room:", hospCode);
            socket.emit('join', { code: hospCode });
        });

        socket.on('update_settings', (settings) => {
            document.getElementById('live-hospital-name').innerText = settings.hospital_name;
            document.getElementById('live-logo').style.display = settings.show_logo ? 'inline-block' : 'none';
        });

        function getTicket() {
            // ส่งรหัสไปด้วยตอนกด
            socket.emit('get_ticket', { code: hospCode });
        }

        socket.on('ticket_printed', (data) => {
            const settings = data.settings;
            const numberPadded = String(data.number).padStart(3, '0');
            const queuesAhead = data.queues_ahead || 0;
            const waitText = queuesAhead > 0 ? `(รออีก ${queuesAhead} คิว)` : "(ถึงคิวท่านถัดไป)";
            
            const now = new Date();
            const dateStr = now.toLocaleDateString('th-TH');
            const timeStr = now.toLocaleTimeString('th-TH').slice(0,5);

            // ใส่ข้อมูลลงกระดาษ
            document.getElementById('print-hospital').innerText = settings.hospital_name;
            document.getElementById('print-title').innerText = settings.ticket_title;
            document.getElementById('print-num').innerText = numberPadded;
            document.getElementById('print-wait').innerText = waitText;
            document.getElementById('print-footer').innerText = settings.ticket_footer;
            document.getElementById('print-time').innerText = `วันที่ ${dateStr} เวลา ${timeStr} น.`;
            document.getElementById('print-logo').style.display = settings.show_logo ? 'inline-block' : 'none';

            // สร้าง QR Code (ลิงก์ไปหน้า check_queue ของรหัสนี้)
            const qrContainer = document.getElementById("qrcode-container");
            if(qrContainer) {
                qrContainer.innerHTML = "";
                const currentUrl = window.location.origin;
                // ลิงก์ต้องมี code ด้วย
                const qrLink = `${currentUrl}/check_queue/${hospCode}?q=${data.number}`;
                
                new QRCode(qrContainer, {
                    text: qrLink,
                    width: 100, height: 100,
                    colorDark : "#000000", colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.M
                });
            }

            Swal.fire({
                title: 'รับบัตรคิวสำเร็จ',
                html: `<h1 style="font-size:4rem; color:#00b09b;">${numberPadded}</h1><h3 class="text-danger">${waitText}</h3>`,
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });

            setTimeout(() => { window.print(); }, 500);
        });
    </script>
</body>
</html>
