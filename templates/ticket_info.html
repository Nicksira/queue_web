<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <style>
        body { font-family: 'Prompt', sans-serif; background: linear-gradient(135deg, #00b09b, #96c93d); margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; color: #333; }
        .card { background: white; width: 85%; max-width: 400px; padding: 30px; border-radius: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .logo { width: 80px; margin-bottom: 15px; }
        .hospital-name { font-size: 1.1rem; color: #555; margin-bottom: 20px; font-weight: 600; }
        .queue-box { background: #f0f2f5; padding: 20px; border-radius: 15px; margin: 20px 0; }
        .queue-label { font-size: 1rem; color: #777; }
        .queue-number { font-size: 5rem; font-weight: bold; color: #00b09b; line-height: 1; margin: 10px 0; }
        
        .status-badge { display: inline-block; padding: 8px 20px; border-radius: 50px; color: white; font-weight: bold; font-size: 1.2rem; margin-bottom: 15px; width: 100%; }
        .status-waiting { background: #ffc107; color: #333; }
        .status-called { background: #28a745; animation: blink 1s infinite; }
        .status-passed { background: #dc3545; }
        
        .wait-info { font-size: 1.5rem; color: #e74c3c; font-weight: bold; }
        .btn-notify { background: #007bff; color: white; border: none; padding: 10px; width: 100%; border-radius: 10px; margin-top: 10px; cursor: pointer; display: none; }
        
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div class="card">
        <img src="/static/logo.png" class="logo" onerror="this.style.display='none'">
        <div class="hospital-name">{{ hospital_name }}</div>
        
        <div class="queue-box">
            <div class="queue-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
            <div class="queue-number">{{ my_queue }}</div>
            
            <div id="status-area">
                {% if status == 'called' %}
                    <div class="status-badge status-called">üîî ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!</div>
                    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
                {% elif status == 'passed' %}
                    <div class="status-badge status-passed">‡πÄ‡∏•‡∏¢‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß</div>
                    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</p>
                {% else %}
                    <div class="status-badge status-waiting">‡∏£‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</div>
                    <div class="wait-info">‡∏£‡∏≠‡∏≠‡∏µ‡∏Å <span id="wait-count">{{ wait_count }}</span> ‡∏Ñ‡∏¥‡∏ß</div>
                {% endif %}
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</span>
            <strong id="current-q">{{ current_queue }}</strong>
        </div>
        
        <button id="btn-enable-notify" class="btn-notify" onclick="requestNotify()">üîï ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß</button>
    </div>

    <audio id="alert-sound" src="/static/ding.mp3"></audio>

    <script>
        const socket = io();
        const myQueue = parseInt("{{ my_queue }}");
        const hospCode = "{{ code }}"; // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏à‡∏≤‡∏Å Server

        // ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        function requestNotify() {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    document.getElementById('btn-enable-notify').style.display = 'none';
                    alert("‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ó‡πà‡∏≤‡∏ô");
                }
            });
            // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
            document.getElementById('alert-sound').play().catch(() => {});
            document.getElementById('alert-sound').pause();
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ç‡∏≠
        if (Notification.permission !== "granted" && Notification.permission !== "denied") {
            document.getElementById('btn-enable-notify').style.display = 'block';
        }

        // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Real-time
        socket.on('connect', () => {
            socket.emit('join', { code: hospCode });
        });

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà
        socket.on('update_display', (data) => {
            const currentQ = data.number;
            document.getElementById('current-q').innerText = String(currentQ).padStart(3, '0');

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏≠‡πÉ‡∏´‡∏°‡πà
            const wait = myQueue - currentQ - 1; // (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ)
            
            const statusArea = document.getElementById('status-area');

            if (currentQ === myQueue) {
                // üî• ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß!
                statusArea.innerHTML = `
                    <div class="status-badge status-called">üîî ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!</div>
                    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
                `;
                notifyUser(); // ‡∏™‡∏±‡πà‡∏ô + ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                
            } else if (currentQ > myQueue) {
                statusArea.innerHTML = '<div class="status-badge status-passed">‡πÄ‡∏•‡∏¢‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß</div><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</p>';
            } else {
                // ‡∏¢‡∏±‡∏á‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà
                const realWait = wait < 0 ? 0 : wait; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏•‡∏ö
                statusArea.innerHTML = `
                    <div class="status-badge status-waiting">‡∏£‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</div>
                    <div class="wait-info">‡∏£‡∏≠‡∏≠‡∏µ‡∏Å <span id="wait-count">${realWait}</span> ‡∏Ñ‡∏¥‡∏ß</div>
                `;
            }
        });

        function notifyUser() {
            // 1. ‡∏™‡∏±‡πà‡∏ô (Android Only)
            if (navigator.vibrate) {
                navigator.vibrate([500, 200, 500, 200, 1000]);
            }

            // 2. ‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏≠‡∏¢‡∏π‡πà)
            const audio = document.getElementById('alert-sound');
            if(audio) audio.play().catch(e => console.log("Audio blocked"));

            // 3. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Notification)
            if (Notification.permission === "granted") {
                new Notification("üîî ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!", {
                    body: `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß ${myQueue} ‡πÄ‡∏ä‡∏¥‡∏ç‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡πà‡∏∞`,
                    icon: '/static/logo.png'
                });
            }
        }
    </script>
</body>
</html>
