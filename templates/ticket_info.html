<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <style>
        body { font-family: 'Prompt', sans-serif; background: linear-gradient(135deg, #00b09b, #96c93d); margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; color: #333; }
        .card { background: white; width: 85%; max-width: 400px; padding: 30px; border-radius: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .logo { width: 80px; margin-bottom: 15px; }
        .hospital-name { font-size: 1.1rem; color: #555; margin-bottom: 20px; font-weight: 600; }
        .queue-box { background: #f0f2f5; padding: 20px; border-radius: 15px; margin: 20px 0; }
        .queue-label { font-size: 1rem; color: #777; }
        .queue-number { font-size: 5rem; font-weight: bold; color: #00b09b; line-height: 1; margin: 10px 0; }
        
        .status-badge { display: inline-block; padding: 8px 20px; border-radius: 50px; color: white; font-weight: bold; font-size: 1.2rem; margin-bottom: 15px; width: 100%; }
        .status-waiting { background: #ffc107; color: #333; }
        .status-called { background: #28a745; animation: blink 1s infinite; }
        .status-passed { background: #dc3545; }
        
        .wait-info { font-size: 1.5rem; color: #e74c3c; font-weight: bold; }
        .btn-notify { 
            background: #007bff; color: white; border: none; padding: 15px; width: 100%; 
            border-radius: 50px; margin-top: 10px; cursor: pointer; 
            font-size: 1.1rem; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
            animation: pulse 2s infinite;
        }
        
        .warning-text { font-size: 0.8rem; color: #888; margin-top: 15px; }

        @keyframes blink { 50% { opacity: 0.5; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div class="card">
        <img src="/static/logo.png" class="logo" onerror="this.style.display='none'">
        <div class="hospital-name">{{ hospital_name }}</div>
        
        <div class="queue-box">
            <div class="queue-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
            <div class="queue-number">{{ my_queue }}</div>
            
            <div id="status-area">
                {% if status == 'called' %}
                    <div class="status-badge status-called">üîî ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!</div>
                    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
                {% elif status == 'passed' %}
                    <div class="status-badge status-passed">‡πÄ‡∏•‡∏¢‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß</div>
                    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</p>
                {% else %}
                    <div class="status-badge status-waiting">‡∏£‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</div>
                    <div class="wait-info">‡∏£‡∏≠‡∏≠‡∏µ‡∏Å <span id="wait-count">{{ wait_count }}</span> ‡∏Ñ‡∏¥‡∏ß</div>
                {% endif %}
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</span>
            <strong id="current-q">{{ current_queue }}</strong>
        </div>
        
        <button id="btn-enable-notify" class="btn-notify" onclick="activateQueueMode()">
            üîî ‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß
        </button>
        
        <p class="warning-text" id="wake-lock-status">‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ (‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏¥‡∏î‡∏à‡∏≠)</p>
    </div>

    <audio id="alert-sound" src="/static/ding.mp3"></audio>

    <script>
        const socket = io();
        const myQueue = parseInt("{{ my_queue }}");
        const hospCode = "{{ code }}"; 
        let wakeLock = null;

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß (‡∏•‡πá‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡∏±‡∏ö + ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á)
        async function activateQueueMode() {
            // 1. ‡∏Ç‡∏≠ Permission ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            if (Notification.permission !== "granted") {
                await Notification.requestPermission();
            }

            // 2. ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Browser ‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ)
            const audio = document.getElementById('alert-sound');
            audio.play().catch(() => {});
            audio.pause();
            audio.currentTime = 0;

            // 3. ‡∏•‡πá‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡∏±‡∏ö (Wake Lock API)
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    document.getElementById('wake-lock-status').innerText = "‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏î‡∏±‡∏ö‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß";
                    document.getElementById('wake-lock-status').style.color = "green";
                    document.getElementById('btn-enable-notify').style.display = 'none';
                    alert("‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ");
                } else {
                    alert("‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ï‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ");
                }
            } catch (err) {
                console.error(`${err.name}, ${err.message}`);
            }
        }

        // Re-acquire lock if screen comes back
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                activateQueueMode();
            }
        });

        socket.on('connect', () => {
            socket.emit('join', { code: hospCode });
        });

        socket.on('update_display', (data) => {
            const currentQ = data.number;
            document.getElementById('current-q').innerText = String(currentQ).padStart(3, '0');

            const wait = myQueue - currentQ - 1; 
            const statusArea = document.getElementById('status-area');

            if (currentQ === myQueue) {
                // ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß!
                statusArea.innerHTML = `
                    <div class="status-badge status-called">üîî ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!</div>
                    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
                `;
                notifyUser(); 
                
            } else if (currentQ > myQueue) {
                statusArea.innerHTML = '<div class="status-badge status-passed">‡πÄ‡∏•‡∏¢‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß</div><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</p>';
            } else {
                const realWait = wait < 0 ? 0 : wait;
                statusArea.innerHTML = `
                    <div class="status-badge status-waiting">‡∏£‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</div>
                    <div class="wait-info">‡∏£‡∏≠‡∏≠‡∏µ‡∏Å <span id="wait-count">${realWait}</span> ‡∏Ñ‡∏¥‡∏ß</div>
                `;
            }
        });

        function notifyUser() {
            // ‡∏™‡∏±‡πà‡∏ô
            if (navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 1000]);

            // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á
            const audio = document.getElementById('alert-sound');
            if(audio) audio.play().catch(e => console.log("Audio blocked"));

            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            if (Notification.permission === "granted") {
                new Notification("üîî ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!", {
                    body: `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß ${myQueue} ‡πÄ‡∏ä‡∏¥‡∏ç‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡πà‡∏∞`,
                    icon: '/static/logo.png'
                });
            }
        }
    </script>
</body>
</html>
