<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <style>
        /* ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏•‡πâ‡∏ô */
        *, *::before, *::after { box-sizing: border-box; }

        body { 
            font-family: 'Prompt', sans-serif; 
            background: linear-gradient(135deg, #00b09b, #96c93d); 
            margin: 0; 
            min-height: 100vh; /* ‡πÉ‡∏ä‡πâ min-height ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏¢‡∏≤‡∏ß */
            display: flex; 
            justify-content: center; 
            align-items: center; 
            color: #333;
            padding: 20px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏à‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
        }
        
        .card { 
            background: white; 
            width: 100%; 
            max-width: 420px; /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î */
            padding: 30px 25px; 
            border-radius: 25px; 
            text-align: center; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            overflow: hidden; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏•‡πâ‡∏ô card */
        }
        
        .logo { 
            width: 80px; 
            height: auto; 
            margin-bottom: 15px; 
        }
        
        .hospital-name { 
            font-size: 1.2rem; 
            color: #444; 
            margin-bottom: 25px; 
            font-weight: 600;
            line-height: 1.4;
            word-wrap: break-word; /* ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ñ‡πâ‡∏≤‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô */
        }
        
        .queue-box { 
            background: #f1f3f5; 
            padding: 25px 15px; 
            border-radius: 20px; 
            margin: 25px 0; 
        }
        
        .queue-label { 
            font-size: 1.1rem; 
            color: #666; 
            margin-bottom: 5px;
        }
        
        /* üü¢ ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏ö‡∏ö Responsive ‡πÑ‡∏°‡πà‡∏•‡πâ‡∏ô‡∏à‡∏≠ */
        .queue-number { 
            /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î 4rem, ‡∏õ‡∏Å‡∏ï‡∏¥ 18% ‡∏Ç‡∏≠‡∏á‡∏à‡∏≠, ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 6.5rem */
            font-size: clamp(4rem, 18vw, 6.5rem); 
            font-weight: 700; 
            color: #00b09b; 
            line-height: 1.1; 
            margin: 10px 0;
            letter-spacing: -2px;
        }
        
        .status-badge { 
            display: inline-block; 
            padding: 10px 25px; 
            border-radius: 50px; 
            color: white; 
            font-weight: bold; 
            font-size: 1.3rem; 
            margin-bottom: 15px; 
            width: 100%; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .status-waiting { background: #ffc107; color: #444; }
        .status-called { background: #28a745; animation: blink 0.8s infinite alternate; box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4); }
        .status-passed { background: #dc3545; }
        
        .wait-info { 
            font-size: 1.4rem; 
            color: #e74c3c; 
            font-weight: bold; 
            margin-top: 10px;
        }
        .wait-info span { font-size: 2rem; }

        .current-q-info {
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 20px; 
            font-size: 1.1rem; 
            color: #555;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß */
        .btn-notify { 
            background: linear-gradient(45deg, #007bff, #0056b3); 
            color: white; 
            border: none; 
            padding: 18px; 
            width: 100%; 
            border-radius: 50px; 
            margin-top: 10px; 
            cursor: pointer; 
            font-size: 1.2rem; 
            font-weight: bold;
            box-shadow: 0 8px 20px rgba(0,123,255,0.3);
            animation: pulse 2s infinite;
            transition: all 0.3s ease;
        }
        .btn-notify:active { transform: scale(0.98); }
        
        .warning-text { 
            font-size: 0.9rem; 
            color: #777; 
            margin-top: 15px; 
            background: #fff3cd;
            padding: 10px;
            border-radius: 10px;
            display: inline-block;
        }

        @keyframes blink { from { opacity: 1; } to { opacity: 0.6; } }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 8px 20px rgba(0,123,255,0.3); } 50% { transform: scale(1.03); box-shadow: 0 15px 30px rgba(0,123,255,0.5); } 100% { transform: scale(1); box-shadow: 0 8px 20px rgba(0,123,255,0.3); } }
    </style>
</head>
<body>
    <div class="card">
        <img src="/static/logo.png" class="logo" alt="Logo" onerror="this.style.display='none'">
        <div class="hospital-name">{{ hospital_name }}</div>
        
        <div class="queue-box">
            <div class="queue-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
            <div class="queue-number">{{ my_queue }}</div>
            
            <div id="status-area">
                {% if status == 'called' %}
                    <div class="status-badge status-called">üîî ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß!</div>
                    <p style="font-size: 1.2rem;">‡πÄ‡∏ä‡∏¥‡∏ç‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞</p>
                {% elif status == 'passed' %}
                    <div class="status-badge status-passed">‡πÄ‡∏•‡∏¢‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß</div>
                    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</p>
                {% else %}
                    <div class="status-badge status-waiting">‡∏£‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</div>
                    <div class="wait-info">‡∏£‡∏≠‡∏≠‡∏µ‡∏Å <span id="wait-count">{{ wait_count }}</span> ‡∏Ñ‡∏¥‡∏ß</div>
                {% endif %}
            </div>
        </div>

        <div class="current-q-info">
            <span>‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å:</span>
            <strong id="current-q" style="font-size: 1.4rem;">{{ current_queue }}</strong>
        </div>
        
        <button id="btn-enable-notify" class="btn-notify" onclick="activateQueueMode()">
            üëâ ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß
        </button>
        
        <div id="wake-lock-status" style="display:none;" class="warning-text">
            ‚úÖ <strong>‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß</strong><br>‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏î‡∏±‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ
        </div>
    </div>

    <audio id="alert-sound" src="/static/ding.mp3" preload="auto"></audio>

    <script>
        const socket = io();
        const myQueue = parseInt("{{ my_queue }}");
        const hospCode = "{{ code }}"; 
        let wakeLock = null;
        const btnNotify = document.getElementById('btn-enable-notify');
        const statusText = document.getElementById('wake-lock-status');

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß (‡∏•‡πá‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ + ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á)
        async function activateQueueMode() {
            // 1. ‡∏Ç‡∏≠ Permission ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            if (Notification.permission !== "granted") {
                Notification.requestPermission();
            }

            // 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å Browser)
            const audio = document.getElementById('alert-sound');
            audio.play().then(() => {
                audio.pause();
                audio.currentTime = 0;
            }).catch(error => console.log("Audio autoplay prevented initially:", error));

            // 3. ‡∏•‡πá‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡∏±‡∏ö (Wake Lock API)
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    btnNotify.style.display = 'none';
                    statusText.style.display = 'inline-block';
                    // alert("‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ");
                } else {
                    alert("‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ï‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏¢‡∏∞");
                    btnNotify.style.display = 'none';
                    statusText.innerText = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ ‡πÅ‡∏•‡∏∞‡πÅ‡∏ï‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏¢‡∏∞";
                    statusText.style.display = 'inline-block';
                }
            } catch (err) {
                console.error(`${err.name}, ${err.message}`);
                btnNotify.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πá‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏î‡πâ (‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)";
            }
        }

        // ‡∏ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏î‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ‡πÉ‡∏´‡πâ‡∏•‡πá‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
            }
        });

        // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Socket
        socket.on('connect', () => {
            socket.emit('join', { code: hospCode });
        });

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Real-time
        socket.on('update_display', (data) => {
            const currentQ = data.number;
            document.getElementById('current-q').innerText = String(currentQ).padStart(3, '0');

            const wait = myQueue - currentQ - 1; 
            const statusArea = document.getElementById('status-area');

            if (currentQ === myQueue) {
                // üî• ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß!
                statusArea.innerHTML = `
                    <div class="status-badge status-called">üîî ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß!</div>
                    <p style="font-size: 1.2rem; font-weight: bold;">‡πÄ‡∏ä‡∏¥‡∏ç‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞</p>
                `;
                notifyUser(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                
            } else if (currentQ > myQueue) {
                statusArea.innerHTML = '<div class="status-badge status-passed">‡πÄ‡∏•‡∏¢‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß</div><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</p>';
            } else {
                const realWait = wait < 0 ? 0 : wait;
                statusArea.innerHTML = `
                    <div class="status-badge status-waiting">‡∏£‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</div>
                    <div class="wait-info">‡∏£‡∏≠‡∏≠‡∏µ‡∏Å <span id="wait-count">${realWait}</span> ‡∏Ñ‡∏¥‡∏ß</div>
                `;
            }
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡πÄ‡∏™‡∏µ‡∏¢‡∏á + ‡∏™‡∏±‡πà‡∏ô + Notification)
        function notifyUser() {
            // 1. ‡∏™‡∏±‡πà‡∏ô (Android)
            if (navigator.vibrate) navigator.vibrate([500, 300, 500, 300, 1000]);

            // 2. ‡πÄ‡∏™‡∏µ‡∏¢‡∏á üîä (‡∏à‡∏∞‡∏î‡∏±‡∏á‡∏ñ‡πâ‡∏≤‡∏ß‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå ding.mp3 ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
            const audio = document.getElementById('alert-sound');
            if(audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.log("Audio play failed:", e));
            }

            // 3. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            if (Notification.permission === "granted" && document.visibilityState === 'hidden') {
                new Notification("üîî ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!", {
                    body: `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß ${myQueue} ‡πÄ‡∏ä‡∏¥‡∏ç‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡πà‡∏∞`,
                    icon: '/static/logo.png'
                });
            }
        }
    </script>
</body>
</html>
